<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VideoFrames: Tag & Extract</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
/* Variables */
:root {
    --bg-color: #1d1c1c;
    --text-color: #e0e0e0;
    --primary-color: #226b9c;
    --primary-hover-color: #3498db;
    --secondary-color: #1d8147;
    --secondary-hover-color: #12b356;
    --third-color: #b17a2b;
    --third-hover-color: #cf931e;
    --fourth-color: #921b1b;
    --fourth-hover-color: #d42a2a;
    --disabled-color: #4a4a4a;
    --timeline-bg: #2c3e50;
    --timeline-indicator: #3498db;
    --timeline-indicator-hover: #acdeff;
    --timeline-indicator-active: #ff0000;
}

/* Global Styles */
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
}

body {
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
}

h1, h2 {
    color: var(--primary-color);
    text-align: center;
    text-shadow: 0px 0px 20px #000000
}
h3 {
    background: linear-gradient(45deg, var(--primary-color) 40%, var(--secondary-color) 60%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    text-shadow: 0px 0px 20px #ffffff24;
    background-clip: text;

}

/* Sidebar Styles */
#sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    background-color: var(--bg-color);
    box-shadow: 2px 0 19px 3px rgba(0, 0, 0, 0.25);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

#sidebar.collapsed {
    transform: translateX(-140px);
}

#sidebarToggle {
    position: absolute;
    right: -42px;
    top: 10px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
    border-radius: 0 5px 5px 0;
    height: 40px;
    transition: all .2s;
}

#sidebarToggle:hover {
    box-shadow: inset 0px 0px 4px 1px #78b3dc, 4px 0px 12px 2px #1b4664;
}

.sidebar-item {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.sidebar-item button,
.sidebar-item label {
    width: 100%;
    padding: 12px 20px;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0px;
    text-shadow: 0 0 5px #000000c9;
}

.sidebar-item:nth-child(3) button { background-color: var(--third-color); }
.sidebar-item:nth-child(3) button:hover { background-color: var(--third-hover-color); }

.sidebar-item:nth-child(4) button { background-color: var(--fourth-color); }
.sidebar-item:nth-child(4) button:hover { background-color: var(--fourth-color); }

.sidebar-item:nth-child(5) button { background-color: var(--primary-color); }
.sidebar-item:nth-child(5) button:hover { background-color: var(--primary-color); }

.sidebar-item:nth-child(6) button { background-color: var(--secondary-color); }
.sidebar-item:nth-child(6) button:hover { background-color: var(--secondary-hover-color); }

.sidebar-item button:hover,
.sidebar-item label:hover {
    transform: translateY(-2px);
}

.sidebar-item input[type="file"] {
    display: none;
}

/* Main Content Styles */
#mainContent {
    margin-left: 140px;
    padding: 10px 20px;
    width: calc(100% - 250px);
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
    overflow-y: hidden;
    height: 100vh;
    box-sizing: border-box;
}

#mainContent.expanded {
    margin-left: 0;
    width: 100%;
}

/* Video Player Styles */
#videoContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 1200px;
    position: relative;
}

#videoPlayer {
    width: 100%;
    height: auto;
    max-height: 80vh;
    object-fit: contain;
}

#frameInfo {
    display: none;
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 14px;
}

/* Timeline Styles */
#timeline {
    width: 100%;
    height: 30px;
    background-color: var(--timeline-bg);
    position: relative;
    cursor: pointer;
    margin-top: 10px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    border-radius: 5px;
    display: none;
}

#progressLine {
    position: absolute;
    height: 100%;
    background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    top: 0;
    left: 0;
    width: 0%;
    z-index: 1;
}

#scrubber {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #fff;
    top: 50%;
    transform: translate(-50%, -50%);
    left: 0;
    cursor: pointer;
    z-index: 2;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    transition: transform 0.1s ease;
}

#scrubber:hover {
    transform: translate(-50%, -50%) scale(1.2);
}

.screenshot-indicator {
    position: absolute;
    width: 4px;
    height: 100%;
    background-color: var(--timeline-indicator);
    transition: background-color 0.3s ease;
    cursor: pointer;
    z-index: 3;
    box-shadow: inset 0px 0px 2px 0px #ffffff69, inset 0px 0px 3px #3c7eff;
}

.screenshot-indicator:hover,
.screenshot-indicator.active {
    background-color: var(--timeline-indicator-active);
    width: 6px;
    box-shadow: 0px 0px 6px #0000008c, inset 0px 0px 1px 1px #ff9393;
    border-radius: 10px;
}

/* Control Styles */
button {
    background-color: var(--secondary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    margin: 10px;
    transition: background-color 0.3s ease;
}

button:disabled {
    background-color: var(--disabled-color) !important;
    cursor: not-allowed;
}

#addFrameButton {
    margin-right: 10px;
    text-shadow: 0 0 5px #000000c9;
    font-size: small;
    transition: all 0.3s;
}

#addFrameButton:hover {
    transform: translateY(-2px);
}

/* Output Styles */
#output {
    margin-top: 20px;
    padding: 10px;
    background-color: var(--timeline-bg);
    border-radius: 5px;
    color: var(--text-color);
    width: fit-content;
    margin: 10px auto;
    display: none;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: var(--bg-color);
    margin: 15% auto;
    padding: 20px;
    border: 1px solid var(--disabled-color);
    width: 300px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: relative;
}

/* Tag Manager Styles */
.tag-manager {
    margin-top: 10px;
}

.tag-manager input {
    width: -webkit-fill-available;
    width: -moz-available;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid var(--disabled-color);
    border-radius: 5px;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-size: 14px;
}

.tag-manager input:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.3);
}

.tag-list {
    max-height: 150px;
    overflow-y: auto;
}

.tag-item {
    display: inline-block;
    background-color: var(--secondary-color);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    margin: 5px 5px 0 0;
    cursor: pointer;
    transition: background-color 0.3s ease;
    font-size: 12px;
}

.tag-item:hover {
    background-color: var(--secondary-hover-color);
}

.delete-tag {
    margin-left: 5px;
    font-weight: bold;
    cursor: pointer;
}

.delete-tag:hover {
    color: var(--primary-color);
}

/* Tag Overlay Styles */
#tagOverlay {
    display: none;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    border-radius: 5px;
    padding: 2.5px;
    margin-left: 10px;
}

.tag-overlay-item {
    display: inline-block;
    color: white;
    padding: 8px 10px;
    border-radius: 5px;
    margin: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    font-size: small;
    border: 1px solid #226b9c7a;
}

.tag-overlay-item:hover {
    background-color: var(--timeline-bg);
}

.tag-overlay-item.selected {
    background-color: #27ae6024;
    border: 1px solid var(--secondary-color);
    box-shadow: 0 0 0px 2px rgb(46 204 113 / 31%);
}

h2 {
    color: #DDD;
    font-family: 'Georgia', serif;
    font-style: italic;
    text-align: center;
    padding: 5px;
    background: linear-gradient(to right, transparent, #226b9c1f 20%, #226b9c1f 80%, transparent);
    position: relative;
}

h2::before,
h2::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--primary-color) 20%, var(--primary-color) 80%, transparent);
}

h2::before { top: 0; }
h2::after { bottom: 0; }

/* Bottom Controls Styles */
#bottomControls {
    display: none;
    justify-content: center;
    align-items: center;
    width: 100%;
    margin-top: 10px;
}

/* Header and Output Styles */
#mainContent h2 {
    margin: 0;
}

#output {
    display: none;
    margin-left: 20px;
    vertical-align: middle;
}

.header-output-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

/* Utility Classes */
.no-select {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* Bottom Right Controls */
#bottomRightControls {
    position: fixed;
    bottom: 10px;
    right: 10px;
    display: flex;
    z-index: 1000;
}

#helpButton,
#settingsButton {
    background-color: var(--primary-color);
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    padding: 10px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#helpButton:hover,
#settingsButton:hover {
    background-color: var(--primary-hover-color);
}

#helpButton svg,
#settingsButton svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
}

#settingsButton {
    margin-right: 10px;
}

/* Help and Settings Modal Styles */
#helpModal,
#settingsModal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    backdrop-filter: blur(5px);
}

#settingsModal h2 {
    margin: 0;
}

.help-modal-content,
.settings-modal-content {
    background-color: var(--bg-color);
    padding: 25px;
    border: 1px solid var(--disabled-color);
    width: 60%;
    max-width: 600px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 80vh;
    overflow-y: auto;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.help-modal-content h2,
.help-modal-content h3,
.settings-modal-content h3 {
    margin-top: 20px;
    margin-bottom: 10px;
}

.help-modal-content p, 
.help-modal-content ul, 
.help-modal-content ol {
    margin-bottom: 15px;
    line-height: 1.5;
}

.help-modal-content ul, 
.help-modal-content ol {
    padding-left: 20px;
}

.help-modal-content li {
    margin-bottom: 5px;
}

.help-modal-content strong {
    color: var(--primary-color);
}
.help-modal-content button {
    padding: 8px;
    cursor: auto;
}

/* Settings Styles */
.settings-group {
    margin-bottom: 20px;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.setting-item label {
    flex: 1;
    margin-right: 10px;
}

.setting-item input,
.setting-item select {
    flex: 1;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid var(--disabled-color);
    background-color: var(--bg-color);
    color: var(--text-color);
    font-size: 14px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.setting-item input:focus,
.setting-item select:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.3);
}

/* Help Button Styles */
.help-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 8px;
    font-size: 0.8em;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: default;
    vertical-align: middle;
    margin: 0 4px;
}

.help-button-extract { background-color: var(--fourth-color); }
.help-button-sidebar,
.help-button-gear { background-color: var(--primary-color); }
.help-button-video,
.help-button-frame { background-color: var(--secondary-color); }
.help-button-tag { background-color: var(--third-color); }

.help-button svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
}

/* Shortcut Key Styles */
.shortcut-key,
.shortcut-key_blank {
    background-color: #3a4559;
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-family: monospace;
    font-weight: bold;
}

.shortcut-input {
    font-family: monospace;
    font-weight: bold;
}

/* Animation Styles */
@keyframes buttonPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
    50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
}

.button-pulse {
    animation: buttonPulse 0.3s ease-in-out;
}

@keyframes glowingBorder {
    0% { box-shadow: inset 0 0 0 0px rgba(46, 204, 113, 0.7), 0 0 0 0px rgba(46, 204, 113, 0.7); }
    50% { box-shadow: inset 0 0 0 2px rgba(46, 204, 113, 1), 0 0 9px 0px rgba(46, 204, 113, 1); }
    100% { box-shadow: inset 0 0 0 0px rgba(46, 204, 113, 0.7), 0 0 0 0px rgba(46, 204, 113, 0.7); }
}

#uploadVideoButton {
    animation: glowingBorder 2s infinite;
    transition: all 0.3s;
}

#uploadVideoButton:hover {
    transform: translateY(-2px);
    background-color: #1d1c1c;
}



#uploadVideoButton.video-loaded {
    animation: none;
}

/* Video Placeholder Styles */
#videoPlaceholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 25%;
    border-radius: 8px;
    color: var(--text-color);
}

#videoPlaceholder svg {
    width: 100%;
    height: 100%;
    color: var(--primary-color);
}

#videoPlaceholder p {
    font-size: 16px;
    text-align: center;
    line-height: 1.5;
    margin: 0;
    opacity: 0.8;
}

/* Loading Indicator Styles */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(29, 28, 28, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.spinner {
    border: 8px solid var(--disabled-color);
    border-top: 8px solid var(--primary-color);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Load Session Button Styles */
#loadSessionButton {
    background-color: var(--primary-color);
}

#loadSessionButton:hover {
    background-color: var(--primary-hover-color);
}

/* Drop Zone Styles */
.drop-zone {
    border: 2px dashed var(--primary-color);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.drop-zone.drag-over {
    background-color: rgba(46, 204, 113, 0.1);
    border-color: var(--secondary-color);
}

.tag-overlay-placeholder {
    color: var(--text-color);
    opacity: 0.7;
    font-style: italic;
    padding: 10px;
    text-align: center;
}

#frameCounter {
    font-weight: bold;
    font-size: 14px;
    background-color: rgba(0, 0, 0, 0.1);
    padding: 5px 10px;
    border-radius: 5px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0px 0px 17px #1e8147, 0px 0px 0px 1px #1daf40a1;
}

/* Add this to the end of your main.css file */
.shortcut-overlay {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background-color: rgb(0 0 0 / 5%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    font-size: 14px;
    z-index: 1000;
    max-width: 300px;
    box-shadow: 0 0 6px 3px rgb(0 0 0 / 31%);
    transition: opacity 0.3s ease;
}

.shortcut-overlay h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 16px;
    color: var(--secondary-color);
    text-shadow: 0px 0px 20px #ffffff2b;
}

.shortcut-overlay ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

.shortcut-overlay li {
    margin-bottom: 5px;
}
#showShortcutOverlay{
    box-shadow: none;
}


.shortcut-overlay .shortcut-key,
.shortcut-overlay .shortcut-key_blank {
    display: inline-block;
    background-color: var(--primary-color);
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    margin-right: 5px;
    font-family: monospace;
    font-weight: bold;
}
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar">
        <button id="sidebarToggle">☰</button>
        <h2>Actions</h2>
       
        <div class="sidebar-item">
            
            <button id="tagManagerButton">Tag Manager</button>
        </div>
        <div class="sidebar-item">
            <button id="extractButton" disabled>Export Frames</button>
        </div>
        <div class="sidebar-item">
            <button id="loadSessionButton">Load Session</button>
            <input type="file" id="loadSessionInput" accept=".zip" style="display: none;">
        </div>
        <div class="sidebar-item">
            <button id="sidebarUploadButton">Upload Video</button>
            <input type="file" id="sidebarVideoInput" accept="video/*,.mkv,.avi,.mov,.flv,.wmv" style="display: none;">
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
        <div class="header-output-container">
            <h2 style="font-size: 1.2em; margin: 0; display: inline-block;">VideoFrames: Tag & Extract</h2>
            <div id="output"></div>
        </div>
        <div id="bottomRightControls">
            <button id="settingsButton" aria-label="Settings">
                <svg viewBox="0 0 24 24">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
            </button>
            <button id="helpButton" aria-label="Help">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                </svg>
            </button>
        </div>

        <div id="shortcutOverlay" class="shortcut-overlay">
            <h3>Keyboard Shortcuts</h3>
            <ul>
                <li><span class="shortcut-key" data-shortcut="addFrame"></span>: Add/Remove Frame</li>
                <li><span class="shortcut-key" data-shortcut="prevFrame"></span>: Previous Frame</li>
                <li><span class="shortcut-key" data-shortcut="nextFrame"></span>: Next Frame</li>
                <li><span class="shortcut-key" data-shortcut="openTagManager"></span>: Open Tag Manager</li>
                <li><span class="shortcut-key_blank">1-9</span>: Assign/Remove Tags</li>
            </ul>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="help-modal-content">
                <h2>How to Use VideoFrames: Tag & Extract</h2>
                
                <h3>Getting Started</h3>
                <ol>
                    <li><strong>Upload a Video:</strong> Click <button class="help-button-video">Upload Video</button> button in the sidebar to select and upload your video.</li>
                    <li><strong>Navigate the Video:</strong> Use the timeline below the video player to navigate through your video. You can click anywhere on the timeline or drag the scrubber for precise navigation.</li>
                    <li><strong>Toggle Sidebar:</strong> Click <button class="help-button-sidebar">☰</button> button to collapse or expand the sidebar for a better view of the video.</li>
                    <li><strong>Replace Video:</strong> To replace the current video, click the <button class="help-button-video">Replace Video</button> button in the sidebar. This will allow you to select a new video file without losing your current tags and settings.</li>
                </ol>

                <h3>Frame Management</h3>
                <ul>
                    <li><strong>Add/Remove Frame:</strong> Press the <span class="shortcut-key" data-shortcut="addFrame"></span> key or click the <button class="help-button-frame">Add/Remove Frame</button> button to mark frames for extraction. The (text) left of button is keyboard shortcut.</li>
                    <li><strong>Navigate Frames:</strong> Use the <span class="shortcut-key" data-shortcut="prevFrame"></span> and <span class="shortcut-key" data-shortcut="nextFrame"></span> keys to move between marked frames. You'll see visual indicators on the timeline for each marked frame.</li>
                    <li><strong>Frame Information:</strong> The frame info display above the video shows the current time and frame details, including any assigned tags.</li>
                </ul>

                <h3>Tagging System</h3>
                <ul>
                    <li><strong>Manage Tags:</strong> Click<button class="help-button-tag">Tag Manager</button> button from the sidebar to create & delete tags.</li>
                    <li><strong>Assign Tags:</strong> Use the tag overlay below the video to assign or remove tags from the current frame. You can click on a tag or use number keys <span class="shortcut-key_blank">1-9</span> for the first 9 tags.</li>
                    <li><strong>View Tags:</strong> Assigned tags are displayed in the frame information and will be included in the extracted frame filenames.</li>
                </ul>

                <h3>Keyboard Shortcuts</h3>
                <ul>
                    <li><strong><span class="shortcut-key" data-shortcut="addFrame"></span>:</strong> Add/Remove current frame</li>
                    <li><strong><span class="shortcut-key" data-shortcut="prevFrame"></span>:</strong> Navigate to previous marked frame</li>
                    <li><strong><span class="shortcut-key" data-shortcut="nextFrame"></span>:</strong> Navigate to next marked frame</li>
                    <li><strong><span class="shortcut-key" data-shortcut="openTagManager"></span>:</strong> Open Tag Manager</li>
                    <li><strong><span class="shortcut-key_blank">1-9</span>:</strong> Quickly assign/remove tags (first 9 tags)</li>
                </ul>

                <h3>Settings</h3>
                <p>Click the <button class="help-button-gear"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg></button> icon in the bottom right to access settings:</p>
                <ul>
                    <li><strong>Shortcuts:</strong> Customize keyboard shortcuts for various actions.</li>
                    <li><strong>Export Settings:</strong> Choose image format, quality, and file naming options for extracted frames.</li>
                    <li><strong>Display Settings:</strong> Toggle the visibility of the shortcut overlay.</li>
                </ul>

                <h3>Extraction</h3>
                <ol>
                    <li>Once you've selected and tagged frames, click the <button class="help-button-extract">Export Frames</button> button in the sidebar.</li>
                    <li>Choose between two export options:
                        <ul>
                            <li><strong>Export Frames Only:</strong> This will export only the selected frames as image files.</li>
                            <li><strong>Export Frames with Session Data:</strong> This will export the frames along with the session data, including the original video, tags, and settings. This option allows you to reload the session later.</li>
                        </ul>
                    </li>
                    <li>Confirm the extraction when prompted.</li>
                    <li>Wait for the extraction process to complete.</li>
                    <li>A ZIP file will be downloaded containing the extracted frames and, if selected, the session data.</li>
                </ol>
                <p>Each frame will be saved as an image file with its assigned tags in the filename.</p>

                <h3>Loading a Session</h3>
                <ol>
                    <li>Click the <button class="help-button-sidebar">Load Session</button> button in the sidebar.</li>
                    <li>Select a previously exported ZIP file containing session data.</li>
                    <li>The application will load the video, frames, tags, and settings from the session file.</li>
                </ol>

                <h3>Additional Tips</h3>
                <ul>
                    <li>Hover over timeline indicators to preview frames without adding them.</li>
                    <li>The extract button is disabled until you've selected at least one frame.</li>
                    <li>You can reorder tags in the Tag Manager by dragging and dropping.</li>
                    <li>Use the settings to customize the application to your workflow.</li>
                    <li>The shortcut overlay can be toggled on/off in the settings menu.</li>
                </ul>
            </div>
        </div>

        <div id="videoContainer">
            <!-- Add this new div for the placeholder -->
            <div id="videoPlaceholder" class="drop-zone">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="64" height="64">
                    <path d="M16 16.25C16 18.0449 14.5449 19.5 12.75 19.5H12.6865C12.89 18.8699 13 18.1978 13 17.5C13 13.9101 10.0899 11 6.5 11C4.75351 11 3.16789 11.6888 2 12.8096V7.75C2 5.95507 3.45507 4.5 5.25 4.5H12.75C14.5449 4.5 16 5.95507 16 7.75V16.25ZM21.762 5.89334C21.9156 6.07414 22 6.30368 22 6.54096V17.4588C22 18.0111 21.5523 18.4588 21 18.4588C20.7627 18.4588 20.5332 18.3744 20.3524 18.2208L17 15.3709V8.62794L20.3524 5.77899C20.7732 5.42132 21.4043 5.47252 21.762 5.89334ZM12 17.5C12 14.4624 9.53757 12 6.5 12C3.46243 12 1 14.4624 1 17.5C1 20.5376 3.46243 23 6.5 23C9.53757 23 12 20.5376 12 17.5ZM7.00065 18L7.00111 20.5035C7.00111 20.7797 6.77725 21.0035 6.50111 21.0035C6.22497 21.0035 6.00111 20.7797 6.00111 20.5035L6.00065 18H3.4956C3.21973 18 2.99609 17.7762 2.99609 17.5C2.99609 17.2239 3.21973 17 3.4956 17H6.00046L6 14.4993C6 14.2231 6.22386 13.9993 6.5 13.9993C6.77614 13.9993 7 14.2231 7 14.4993L7.00046 17H9.49659C9.77246 17 9.99609 17.2239 9.99609 17.5C9.99609 17.7762 9.77246 18 9.49659 18H7.00065Z"/>
                </svg>
                <p>Drag and drop a video file here<br>or click <button id="uploadVideoButton">Upload Video</button><input type="file" id="videoInput" accept="video/*,.mkv,.avi,.mov,.flv,.wmv" style="display: none;"> to begin.</p>
            </div>
            <!-- Existing video player -->
            <video id="videoPlayer"></video>
            <div id="frameInfo"></div>
            <div id="timeline" style="display: none;">
                <div id="progressLine"></div>
                <div id="scrubber"></div>
            </div>
            <div id="bottomControls" style="display: none;">
                <button id="addFrameButton">Add/Remove Frame (F)</button>
                <div id="frameCounter" style="margin-left: 10px; color: var(--secondary-color);"></div>
                <div class="controls-divider"></div>
                <div id="tagOverlay"></div>
            </div>
        </div>
    </div>

    <!-- Tag Manager Modal -->
    <div id="tagManagerModal" class="modal">
        <div class="modal-content">
            <div class="tag-manager">
                <h2 style="margin-bottom: 38px;">Tag Manager</h2>
                <input type="text" id="newTagInput" placeholder="Add new tag (press Enter)">
                <div id="tagList"></div>
            </div>
        </div>
    </div>

    <!-- Add Loading Indicator -->
    <div id="loadingIndicator" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="settings-modal-content">
            <h2>Settings</h2>
            
            <div class="settings-group">
                <h3>Shortcuts</h3>
                <div class="setting-item">
                    <label for="addFrameShortcut">Add/Remove Frame:</label>
                    <input type="text" id="addFrameShortcut" class="shortcut-input" data-shortcut="addFrame">
                </div>
                <div class="setting-item">
                    <label for="prevFrameShortcut">Previous Frame:</label>
                    <input type="text" id="prevFrameShortcut" class="shortcut-input" data-shortcut="prevFrame">
                </div>
                <div class="setting-item">
                    <label for="nextFrameShortcut">Next Frame:</label>
                    <input type="text" id="nextFrameShortcut" class="shortcut-input" data-shortcut="nextFrame">
                </div>
                <div class="setting-item">
                    <label for="openTagManagerShortcut">Open Tag Manager:</label>
                    <input type="text" id="openTagManagerShortcut" class="shortcut-input" data-shortcut="openTagManager">
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Export Settings</h3>
                <div class="setting-item">
                    <label for="imageFormat">Image Format:</label>
                    <select id="imageFormat">
                        <option value="png">PNG (Lossless)</option>
                        <option value="jpeg">JPEG (Lossy)</option>
                        <option value="webp">WebP</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="imageQuality">JPEG/WebP Quality (1-100):</label>
                    <input type="number" id="imageQuality" min="1" max="100" value="90">
                </div>
                <div class="setting-item">
                    <label for="zipFileName">ZIP File Name:</label>
                    <input type="text" id="zipFileName" value="extracted_frames">
                </div>
                <div class="setting-item">
                    <label for="imageFilePrefix">Image File Prefix:</label>
                    <input type="text" id="imageFilePrefix" value="frame">
                </div>
            </div>

            <div class="settings-group">
                <h3>Display Settings</h3>
                <div class="setting-item">
                    <label for="showShortcutOverlay">Show Shortcut Overlay:</label>
                    <input type="checkbox" id="showShortcutOverlay">
                </div>
            </div>



        </div>
    </div>

    <!-- JavaScript Code -->
<script>
    (function() {
    'use strict';

    // ---------------------------
    // Element Selectors
    // ---------------------------
    const elements = {
        videoInput: document.getElementById('videoInput'),
        extractButton: document.getElementById('extractButton'),
        output: document.getElementById('output'),
        videoPlayer: document.getElementById('videoPlayer'),
        timeline: document.getElementById('timeline'),
        scrubber: document.getElementById('scrubber'),
        progressLine: document.getElementById('progressLine'),
        frameInfo: document.getElementById('frameInfo'),
        sidebar: document.getElementById('sidebar'),
        sidebarToggle: document.getElementById('sidebarToggle'),
        mainContent: document.getElementById('mainContent'),
        tagList: document.getElementById('tagList'),
        newTagInput: document.getElementById('newTagInput'),
        tagManagerButton: document.getElementById('tagManagerButton'),
        tagManagerModal: document.getElementById('tagManagerModal'),
        tagOverlay: document.getElementById('tagOverlay'),
        addFrameButton: document.getElementById('addFrameButton'),
        helpButton: document.getElementById('helpButton'),
        helpModal: document.getElementById('helpModal'),
        settingsButton: document.getElementById('settingsButton'),
        settingsModal: document.getElementById('settingsModal'),
        settingsInputs: document.querySelectorAll('#settingsModal input, #settingsModal select'),
        videoPlaceholder: document.getElementById('videoPlaceholder'),
        uploadVideoButton: document.getElementById('uploadVideoButton'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        frameCounter: document.getElementById('frameCounter'),
        loadSessionButton: document.getElementById('loadSessionButton'),
        loadSessionInput: document.getElementById('loadSessionInput'),
        shortcutOverlay: document.getElementById('shortcutOverlay'),
        showShortcutOverlayCheckbox: document.getElementById('showShortcutOverlay'),
        sidebarUploadButton: document.getElementById('sidebarUploadButton'),
        sidebarVideoInput: document.getElementById('sidebarVideoInput')
    };

    // ---------------------------
    // Application State Variables
    // ---------------------------
    let videoSrc = '';
    let zipInstance = null;
    let tags = [];
    let frameTags = {}; // { 'frame_1.png': ['tag1', 'tag2'], ... }
    let selectedFrames = []; // Array to store selected frame times
    let currentIndicatorIndex = -1;
    let isTagManagerOpen = false;
    let isSettingsModalOpen = false;
    let originalVideoName = '';

    let isScrubberDragging = false;

    // ---------------------------
    // Settings
    // ---------------------------
    const defaultSettings = {
        shortcuts: {
            addFrame: 'F',
            prevFrame: 'ArrowLeft',
            nextFrame: 'ArrowRight',
            openTagManager: 'T'
        },
        export: {
            imageFormat: 'jpeg',
            imageQuality: 100,
            zipFileName: 'Session_Data',
            imageFilePrefix: 'Frame'
        },
        display: {
            showShortcutOverlay: true
        }
    };

    let settings = { ...defaultSettings };

    // ---------------------------
    // Initialization
    // ---------------------------
    loadSettings();
    updateSettingsUI();
    updateShortcutDisplay();
    updateQualityInputVisibility();
    updateExtractButtonState();
    frameInfo.style.display = 'none';

    // ---------------------------
    // Event Listeners
    // ---------------------------

    // Video Upload Handlers
    elements.uploadVideoButton.addEventListener('click', () => {
        elements.videoInput.click();
    });

    elements.videoInput.addEventListener('change', handleVideoInputChange);

    elements.videoPlaceholder.addEventListener('dragover', handleDragOver);
    elements.videoPlaceholder.addEventListener('dragleave', handleDragLeave);
    elements.videoPlaceholder.addEventListener('drop', handleDrop);

    // Window Resizing
    window.addEventListener('resize', resizeVideo);

    // Extraction
    elements.extractButton.addEventListener('click', confirmExtraction);

    // Video Player Events
    elements.videoPlayer.addEventListener('timeupdate', handleVideoTimeUpdate);
    elements.videoPlayer.addEventListener('emptied', handleVideoEmptied);
    elements.videoPlayer.addEventListener('play', preventVideoPlay);

    // Sidebar Toggle
    elements.sidebarToggle.addEventListener('click', toggleSidebar);

    // Tag Manager
    elements.newTagInput.addEventListener('keypress', handleNewTagInputKeyPress);
    elements.tagManagerButton.addEventListener('click', openTagManager);
    elements.addFrameButton.addEventListener('click', addFrame);

    // Timeline and Scrubber
    elements.timeline.addEventListener('mousedown', handleTimelineMouseDown);
    elements.timeline.addEventListener('click', handleTimelineClick);
    document.addEventListener('mousemove', handleDocumentMouseMove);
    document.addEventListener('mouseup', handleDocumentMouseUp);

    // Modal Close Handlers
    window.addEventListener('click', handleWindowClick);
    document.addEventListener('keydown', handleGlobalKeyDown);

    // Shortcut Inputs
    document.querySelectorAll('.shortcut-input').forEach(input => {
        input.addEventListener('keydown', handleShortcutInput);
    });

    // Help Modal
    elements.helpButton.addEventListener('click', () => {
        elements.helpModal.style.display = 'block';
    });

    window.addEventListener('click', (event) => {
        if (event.target === elements.helpModal) {
            elements.helpModal.style.display = 'none';
        }
    });

    // Settings Modal
    elements.settingsButton.addEventListener('click', () => {
        elements.settingsModal.style.display = 'block';
        isSettingsModalOpen = true;
    });

    window.addEventListener('click', (event) => {
        if (event.target === elements.settingsModal) {
            closeSettingsModal();
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && elements.settingsModal.style.display === 'block') {
            closeSettingsModal();
        }
    });

    // Settings Inputs
    document.querySelector('.settings-modal-content').addEventListener('input', handleSettingsInput);

    // Load Session
    elements.loadSessionButton.addEventListener('click', () => {
        elements.loadSessionInput.click();
    });

    elements.loadSessionInput.addEventListener('change', handleLoadSession);

    // Prevent text selection during scrubbing
    document.addEventListener('mousedown', (event) => {
        if (event.target === elements.timeline || event.target === elements.scrubber) {
            document.body.classList.add('no-select');
        }
    });

    document.addEventListener('mouseup', () => {
        document.body.classList.remove('no-select');
    });

    // Prevent default drag behavior
    document.addEventListener('dragstart', preventDefaultDrag);
    elements.timeline.addEventListener('mousedown', () => {
        document.addEventListener('mousemove', preventDefaultDrag);
    });
    document.addEventListener('mouseup', () => {
        document.removeEventListener('mousemove', preventDefaultDrag);
    });

    // Sidebar Upload Button
    elements.sidebarUploadButton.addEventListener('click', () => {
        elements.sidebarVideoInput.click();
    });

    elements.sidebarVideoInput.addEventListener('change', handleVideoInputChange);

    // Add this to the Event Listeners section
    document.addEventListener('keydown', (event) => {
        // Don't handle shortcuts if we're in an input field or modal
        if (event.target.tagName === 'INPUT' || isModalOpen()) {
            return;
        }

        if (event.key === 'Escape') {
            if (elements.tagManagerModal.style.display === 'block') {
                closeTagManager();
            }
            if (elements.helpModal.style.display === 'block') {
                elements.helpModal.style.display = 'none';
            }
        } else if (event.key === ' ' || event.key === 'Spacebar') {
            event.preventDefault(); // Prevent page scrolling
            if (elements.videoPlayer.src) {
                if (elements.videoPlayer.paused) {
                    elements.videoPlayer.play();
                } else {
                    elements.videoPlayer.pause();
                }
            }
        } else if (isTagManagerOpen || isSettingsModalOpen) return;

        const key = event.key.toLowerCase();
        const shortcuts = settings.shortcuts;

        // ... rest of your existing shortcut handling code ...
    });

    // ---------------------------
    // Function Definitions
    // ---------------------------

    // ---------------------------
    // Video Handling Functions
    // ---------------------------
    function handleVideoInputChange(event) {
        const file = event.target.files[0];
        if (file) {
            handleVideoFile(file);
            updateFrameCounter();
            
            // Reset both file inputs
            elements.videoInput.value = '';
            elements.sidebarVideoInput.value = '';
        }
    }

    function handleVideoFile(file) {
        originalVideoName = file.name;
        resetVideoState();

        videoSrc = URL.createObjectURL(file);
        elements.videoPlayer.src = videoSrc;
        elements.videoPlayer.controls = false;
        elements.videoPlayer.muted = false;

        elements.videoPlayer.addEventListener('loadedmetadata', () => {
            if (elements.videoPlayer.videoWidth === 0 || elements.videoPlayer.videoHeight === 0) {
                displayError(`Error: The selected file format is not supported by your browser.`);
                URL.revokeObjectURL(videoSrc);
                updateFrameCounter();
                return;
            }

            displayOutput(`Video loaded: <span style="color: var(--secondary-color); text-shadow: 0px 0px 1px #000000;">${file.name}</span>`);
            showUIElements(true);

            resizeVideo();
            updateTagOverlay();
            updateExtractButtonState();

            resetScrubberAndProgress();
            hideVideoPlaceholder();
            stopUploadButtonAnimation();
            
            // Update sidebar upload button text
            elements.sidebarUploadButton.textContent = 'Replace Video';
        });

        elements.videoPlayer.addEventListener('error', () => {
            displayError(`Error: Unable to load the video. The format may not be supported.`);
            URL.revokeObjectURL(videoSrc);
        });
    }

    function resetVideoState() {
        selectedFrames = [];
        frameTags = {};
        currentIndicatorIndex = -1;

        clearScreenshotIndicators();
        clearTagOverlay();
        clearFrameInfo();
        
        // Reset frame counter
        updateFrameCounter();
    }

    function handleVideoTimeUpdate() {
        updateFrameInfo();
        updateTagOverlay();
        updateActiveIndicator();
        updateScrubberPosition();
        updateProgressLine();
    }

    function handleVideoEmptied() {
        clearFrameInfo();
        clearTagOverlay();
        resetScrubberAndProgress();
        hideTimelineAndControls();
        updateExtractButtonState();
    }

    function preventVideoPlay(event) {
        // Only prevent automatic playing, not user-initiated playing
        if (!event.isTrusted) {
            event.preventDefault();
            elements.videoPlayer.pause();
        }
    }

    // ---------------------------
    // Drag and Drop Handlers
    // ---------------------------
    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        elements.videoPlaceholder.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        elements.videoPlaceholder.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        elements.videoPlaceholder.classList.remove('drag-over');

        const file = e.dataTransfer.files[0];
        if (file && isValidVideoFile(file)) {
            handleVideoFile(file);
            updateFrameCounter();
        } else {
            alert('Please drop a valid video file.');
        }
    }

    function isValidVideoFile(file) {
        return file.type.startsWith('video/') || file.name.endsWith('.mkv');
    }

    // ---------------------------
    // UI Update Functions
    // ---------------------------
    function displayOutput(message) {
        elements.output.innerHTML = message;
        elements.output.style.display = 'block';
    }

    function displayError(message) {
        displayOutput(message);
    }

    function showUIElements(show) {
        elements.timeline.style.display = show ? 'block' : 'none';
        document.getElementById('bottomControls').style.display = show ? 'flex' : 'none';
        elements.frameInfo.style.display = show ? 'block' : 'none';
    }

    function resetScrubberAndProgress() {
        elements.scrubber.style.left = '0%';
        elements.progressLine.style.width = '0%';
    }

    function hideVideoPlaceholder() {
        elements.videoPlaceholder.style.display = 'none';
    }

    function hideTimelineAndControls() {
        elements.timeline.style.display = 'none';
        document.getElementById('bottomControls').style.display = 'none';
    }

    function clearScreenshotIndicators() {
        const indicators = elements.timeline.querySelectorAll('.screenshot-indicator');
        indicators.forEach(indicator => indicator.remove());
    }

    function clearTagOverlay() {
        elements.tagOverlay.innerHTML = '';
        elements.tagOverlay.style.display = 'none';
    }

    function clearFrameInfo() {
        elements.frameInfo.textContent = '';
        elements.frameInfo.style.display = 'none';
    }

    function resetUploadButtonAnimation() {
        elements.uploadVideoButton.classList.remove('video-loaded');
    }

    function stopUploadButtonAnimation() {
        elements.uploadVideoButton.classList.add('video-loaded');
    }

    function updateExtractButtonState() {
        extractButton.disabled = selectedFrames.length === 0 || !videoPlayer.src;
    }

    function resizeVideo() {
        const aspectRatio = videoPlayer.videoWidth / videoPlayer.videoHeight;
        const newHeight = videoPlayer.offsetWidth / aspectRatio;
        const maxHeight = window.innerHeight * 0.8;

        if (newHeight > maxHeight) {
            videoPlayer.style.height = `${maxHeight}px`;
            videoPlayer.style.width = `${maxHeight * aspectRatio}px`;
        } else {
            videoPlayer.style.height = `${newHeight}px`;
            videoPlayer.style.width = '100%';
        }

        if (videoPlayer.readyState > 0) {
            frameInfo.style.display = 'block';
            updateFrameInfo();
        }
    }

    // ---------------------------
    // Frame Extraction Functions
    // ---------------------------
    function confirmExtraction() {
        const frameCount = selectedFrames.length;

        const exportOptions = `
            <p>Choose export option:</p>
            <button id="exportFramesOnly" class="export-button">Export Frames Only</button>
            <button id="exportFramesWithSession" class="export-button">Export Frames with Session Data</button>
        `;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';

        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.innerHTML = `
            <h3>Export ${frameCount} Frames</h3>
            ${exportOptions}
        `;

        // Add styles for the export buttons
        const style = document.createElement('style');
        style.textContent = `
            .export-button {
                background-color: var(--secondary-color);
                color: white;
                border: 1px solid #ffffff26;
                padding: 10px 20px;
                margin: 10px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s ease;
            }
            #exportFramesWithSession {
                background-color: var(--primary-color);
            }
            .export-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
        `;
        document.head.appendChild(style);

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        document.getElementById('exportFramesOnly').addEventListener('click', () => {
            document.body.removeChild(modal);
            extractFrames(false);
        });

        document.getElementById('exportFramesWithSession').addEventListener('click', () => {
            document.body.removeChild(modal);
            extractFrames(true);
        });

        // Close modal when clicking outside
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    async function extractFrames(includeSessionData = true) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        zipInstance = new JSZip();
        const sessionFolder = zipInstance.folder(settings.export.zipFileName);

        elements.extractButton.disabled = true;

        // Show loading overlay
        const loadingMessage = createLoadingMessage('Starting frame extraction...');
        elements.loadingIndicator.appendChild(loadingMessage);
        elements.loadingIndicator.style.display = 'flex';

        const totalFrames = selectedFrames.length;
        let extractedFrames = 0;

        try {
            for (let i = 0; i < selectedFrames.length; i++) {
                await extractSingleFrame(selectedFrames[i], canvas, ctx, sessionFolder, i);
                extractedFrames++;
                loadingMessage.textContent = `Extracting frames: ${extractedFrames} / ${totalFrames}`;
            }

            loadingMessage.textContent = 'Frames extracted. Processing...';

            if (includeSessionData) {
                await addVideoAndSessionData(sessionFolder);
                const readmeContent = createReadmeContent();
                sessionFolder.file('README.txt', readmeContent);
            }

            const loadingInterval = animateLoadingMessage('Preparing ZIP file', loadingMessage);

            const zipBlob = await zipInstance.generateAsync({ type: 'blob' });
            clearInterval(loadingInterval);
            
            // Modify the zip file name if only frames are exported
            const zipFileName = includeSessionData 
                ? `${settings.export.zipFileName}.zip`
                : `${settings.export.zipFileName}_frames_only.zip`;
            
            saveAs(zipBlob, zipFileName);

            loadingMessage.textContent = 'Download ready.';
            elements.extractButton.disabled = false;
            displayOutput(`${extractedFrames} frames extracted and zipped${includeSessionData ? ' with session data' : ''}.`);
        } catch (error) {
            console.error('Error during extraction:', error);
            displayError(`Error during extraction: ${error.message}`);
            elements.extractButton.disabled = false;
        } finally {
            elements.loadingIndicator.style.display = 'none';
            elements.loadingIndicator.removeChild(loadingMessage);
        }
    }

    function createLoadingMessage(initialText) {
        const messageElem = document.createElement('div');
        messageElem.style.color = 'white';
        messageElem.style.marginLeft = '20px';
        messageElem.style.fontSize = '18px';
        messageElem.textContent = initialText;
        return messageElem;
    }

    async function extractSingleFrame(time, canvas, ctx, sessionFolder, index) {
        return new Promise((resolve) => {
            elements.videoPlayer.currentTime = time;
            elements.videoPlayer.onseeked = () => {
                canvas.width = elements.videoPlayer.videoWidth;
                canvas.height = elements.videoPlayer.videoHeight;
                ctx.drawImage(elements.videoPlayer, 0, 0, canvas.width, canvas.height);

                const mimeType = `image/${settings.export.imageFormat}`;
                const quality = settings.export.imageFormat === 'png' ? undefined : settings.export.imageQuality / 100;

                canvas.toBlob(async (blob) => {
                    if (blob) {
                        const frameNumber = index + 1;
                        const baseFilename = `${settings.export.imageFilePrefix}_${frameNumber}.${settings.export.imageFormat}`;
                        const tagsForFrame = frameTags[baseFilename] || [];
                        const taggedFilename = tagsForFrame.length > 0
                            ? `[${tagsForFrame.join('][')}]${baseFilename}`
                            : baseFilename;
                        sessionFolder.file(taggedFilename, blob);
                    } else {
                        console.error(`Failed to extract frame at ${time}s`);
                    }
                    resolve();
                }, mimeType, quality);
            };
        });
    }

    async function addVideoAndSessionData(sessionFolder) {
        try {
            const videoBlob = await fetch(videoSrc).then(res => res.blob());
            let videoExtension = getVideoExtension(videoBlob, originalVideoName);
            const videoFilename = `video.${videoExtension}`;
            sessionFolder.file(videoFilename, videoBlob);

            const sessionData = {
                videoName: originalVideoName,
                videoType: videoBlob.type,
                videoLength: elements.videoPlayer.duration,
                selectedFrames: selectedFrames,
                frameTags: frameTags,
                settings: settings,
                tags: tags,
                zipFileName: settings.export.zipFileName
            };
            sessionFolder.file('session.json', JSON.stringify(sessionData, null, 2));
        } catch (error) {
            throw new Error(`Failed to add video and session data: ${error.message}`);
        }
    }
    function getVideoExtension(videoBlob, originalName) {
        let extension = videoBlob.type.split('/')[1];
        if (extension === 'plain' || !extension) {
            const parts = originalName.split('.');
            extension = parts.length > 1 ? parts.pop().toLowerCase() : 'mkv';
        }
        return extension;
    }

    function createReadmeContent() {
        const sessionData = {
            videoName: originalVideoName,
            videoLength: elements.videoPlayer.duration,
            selectedFrames: selectedFrames,
            frameTags: frameTags,
            settings: settings,
            tags: tags,
            zipFileName: settings.export.zipFileName
        };

        return `VideoFrames: Tag & Extract - Session Archive

This ZIP archive contains extracted video frames, session data, and the original video file.

Contents:
1. Extracted Frames: Image files of the selected video frames
2. session.json: Contains session data including frame timings, tags, and settings
3. video.{extension}: The original video file
4. README.txt: This file

How to use this archive:
1. To view extracted frames: Open the image files in any image viewer
2. To reload the session:
    a. Go to the VideoFrames: Tag & Extract web application
    b. Click the "Load Session" button
    c. Select this ZIP file

Session Information:
- Video Name: ${sessionData.videoName}
- Video Duration: ${formatDuration(sessionData.videoLength)}
- Number of Extracted Frames: ${sessionData.selectedFrames.length}
- Tags Used: ${sessionData.tags.join(', ')}

For more information on using VideoFrames: Tag & Extract, please refer to the help documentation in the application.

Created on: ${new Date().toLocaleString()}
`;
    }

    function formatDuration(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // ---------------------------
    // Scrubber and Timeline Functions
    // ---------------------------
    function handleTimelineMouseDown(event) {
        isScrubberDragging = true;
        seekVideo(event);
    }

    function handleTimelineClick(event) {
        seekVideo(event);
    }

    function handleDocumentMouseMove(event) {
        if (isScrubberDragging) {
            seekVideo(event);
        }
    }

    function handleDocumentMouseUp() {
        if (isScrubberDragging) {
            isScrubberDragging = false;
            document.body.classList.remove('no-select');
        }
    }

    function seekVideo(event) {
        const rect = elements.timeline.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const percentage = Math.min(Math.max(x / elements.timeline.offsetWidth, 0), 1);
        let newTime = percentage * elements.videoPlayer.duration;

        // Reduce snap threshold from 1% to 0.25% of video duration
        const snapThreshold = 0.0025 * elements.videoPlayer.duration;
        const nearestFrame = findNearestFrame(newTime, snapThreshold);

        if (nearestFrame !== null) {
            newTime = nearestFrame;
        }

        elements.videoPlayer.currentTime = newTime;
        updateScrubberPosition();
        updateProgressLine();
        updateFrameInfo();
        updateTagOverlay();
        updateActiveIndicator();
    }

    function findNearestFrame(time, threshold) {
        let nearest = null;
        let minDistance = Infinity;

        selectedFrames.forEach(frameTime => {
            const distance = Math.abs(frameTime - time);
            if (distance < minDistance && distance < threshold) {
                minDistance = distance;
                nearest = frameTime;
            }
        });

        return nearest;
    }

    function updateScrubberPosition() {
        const percentage = (elements.videoPlayer.currentTime / elements.videoPlayer.duration) * 100;
        elements.scrubber.style.left = `calc(${percentage}% + 3px)`; // Adjust for scrubber width
    }

    function updateProgressLine() {
        const percentage = (elements.videoPlayer.currentTime / elements.videoPlayer.duration) * 100;
        elements.progressLine.style.width = `${Math.min(percentage + 0.25, 100)}%`;
    }

    // ---------------------------
    // Frame and Tag Management Functions
    // ---------------------------
    function addFrame() {
        const currentTime = elements.videoPlayer.currentTime;
        const existingIndex = selectedFrames.findIndex(time => Math.abs(time - currentTime) < 0.1);

        if (existingIndex === -1) {
            selectedFrames.push(currentTime);
        } else {
            selectedFrames.splice(existingIndex, 1);
            const frameFilename = `${settings.export.imageFilePrefix}_${existingIndex + 1}.${settings.export.imageFormat}`;
            delete frameTags[frameFilename];
        }

        selectedFrames.sort((a, b) => a - b);
        updateScreenshotIndicators();
        updateFrameInfo();
        updateFrameCounter();
        updateExtractButtonState();
    }

    function updateScreenshotIndicators() {
        clearScreenshotIndicators();

        selectedFrames.forEach((time, index) => {
            const indicator = document.createElement('div');
            indicator.className = 'screenshot-indicator';
            indicator.style.left = `${(time / elements.videoPlayer.duration) * 100}%`;
            indicator.title = `Frame at ${time.toFixed(2)} seconds`;
            indicator.dataset.time = time;
            indicator.dataset.index = index;

            indicator.addEventListener('click', (event) => {
                event.stopPropagation();
                elements.videoPlayer.currentTime = time;
                updateFrameInfo();
                updateTagOverlay();
                updateActiveIndicator();
                currentIndicatorIndex = index;
            });

            indicator.addEventListener('mouseenter', handleIndicatorMouseEnter);

            elements.timeline.appendChild(indicator);
        });

        if (currentIndicatorIndex >= selectedFrames.length) {
            currentIndicatorIndex = selectedFrames.length - 1;
        }
    }

    function handleIndicatorMouseEnter(event) {
        const time = parseFloat(event.target.dataset.time);
        elements.videoPlayer.currentTime = time;
        updateScrubberPosition();
    }

    function updateActiveIndicator() {
        const indicators = elements.timeline.querySelectorAll('.screenshot-indicator');
        indicators.forEach((indicator, index) => {
            const indicatorTime = parseFloat(indicator.dataset.time);
            if (Math.abs(elements.videoPlayer.currentTime - indicatorTime) < 0.5) {
                indicator.classList.add('active');
                currentIndicatorIndex = index;
            } else {
                indicator.classList.remove('active');
            }
        });
    }

    function updateFrameInfo() {
        if (elements.videoPlayer.readyState === 0) {
            elements.frameInfo.style.display = 'none';
            return;
        }

        const currentTime = elements.videoPlayer.currentTime;
        const index = selectedFrames.findIndex(time => Math.abs(time - currentTime) < 0.1);
        const frameNumber = index + 1;
        let currentFrame = '';
        let taggedFilename = '';

        if (index !== -1) {
            currentFrame = `${settings.export.imageFilePrefix}_${frameNumber}.${settings.export.imageFormat}`;
            const tagsForFrame = frameTags[currentFrame] || [];
            taggedFilename = tagsForFrame.length > 0
                ? `[${tagsForFrame.join('][')}]${currentFrame}`
                : currentFrame;
        }

        const timeString = formatDuration(currentTime);
        elements.frameInfo.textContent = `Time: ${timeString} - ${taggedFilename}`;
        elements.frameInfo.style.display = 'block';
    }

    function updateTagOverlay() {
        elements.tagOverlay.innerHTML = '';

        if (elements.videoPlayer.readyState === 0) {
            elements.tagOverlay.style.display = 'none';
            return;
        }

        if (tags.length === 0) {
            const placeholder = document.createElement('span');
            placeholder.className = 'tag-overlay-placeholder';
            placeholder.textContent = 'No tags available. Click "Tag Manager" to add tags.';
            elements.tagOverlay.appendChild(placeholder);
            elements.tagOverlay.style.display = 'flex';
            return;
        }

        const currentFrame = getCurrentFrameFilename();
        const tagsForFrame = frameTags[currentFrame] || [];

        tags.slice(0, 9).forEach((tag, index) => { // Limit to first 9 tags
            const tagElem = document.createElement('span');
            tagElem.className = 'tag-overlay-item';
            tagElem.textContent = `${tag} (${index + 1})`;
            tagElem.dataset.tag = tag;

            if (tagsForFrame.includes(tag)) {
                tagElem.classList.add('selected');
            }

            tagElem.addEventListener('click', () => {
                toggleTagForCurrentFrame(tag);
                updateTagOverlay();
                updateFrameInfo();
            });

            elements.tagOverlay.appendChild(tagElem);
        });

        elements.tagOverlay.style.display = 'flex';
    }

    function toggleTagForCurrentFrame(tag) {
        const currentFrame = getCurrentFrameFilename();
        if (!currentFrame) return;

        if (!frameTags[currentFrame]) {
            frameTags[currentFrame] = [];
        }

        if (frameTags[currentFrame].includes(tag)) {
            frameTags[currentFrame] = frameTags[currentFrame].filter(t => t !== tag);
            if (frameTags[currentFrame].length === 0) {
                delete frameTags[currentFrame];
            }
        } else {
            frameTags[currentFrame].push(tag);
        }
    }

    function getCurrentFrameFilename() {
        const currentTime = elements.videoPlayer.currentTime;
        const index = selectedFrames.findIndex(time => Math.abs(time - currentTime) < 0.1);
        if (index === -1) return null;
        return `${settings.export.imageFilePrefix}_${index + 1}.${settings.export.imageFormat}`;
    }

    function updateFrameCounter() {
        elements.frameCounter.textContent = `Frames: ${selectedFrames.length}`;
    }

    // ---------------------------
    // Tag Management Functions
    // ---------------------------
    function openTagManager() {
        elements.tagManagerModal.style.display = 'block';
        isTagManagerOpen = true;
        setTimeout(() => {
            elements.newTagInput.focus();
            elements.newTagInput.value = '';
        }, 0);
    }

    function closeTagManager() {
        elements.tagManagerModal.style.display = 'none';
        isTagManagerOpen = false;
    }

    function handleNewTagInputKeyPress(event) {
        if (event.key === 'Enter') {
            addNewTag();
        }
    }

    function addNewTag() {
        const tag = elements.newTagInput.value.trim();
        if (tag && !tags.includes(tag)) {
            tags.push(tag);
            renderTags();
            elements.newTagInput.value = '';
            updateTagOverlay();
        }
    }

    function renderTags() {
        elements.tagList.innerHTML = '';
        tags.forEach(tag => {
            const tagElem = document.createElement('span');
            tagElem.className = 'tag-item';
            tagElem.innerHTML = `${tag} <span class="delete-tag">&times;</span>`;
            tagElem.dataset.tag = tag;

            const deleteButton = tagElem.querySelector('.delete-tag');
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTag(tag);
            });

            elements.tagList.appendChild(tagElem);
        });
    }

    function deleteTag(tagToDelete) {
        tags = tags.filter(tag => tag !== tagToDelete);

        for (const frame in frameTags) {
            frameTags[frame] = frameTags[frame].filter(tag => tag !== tagToDelete);
            if (frameTags[frame].length === 0) {
                delete frameTags[frame];
            }
        }

        renderTags();
        updateTagOverlay();
        updateFrameInfo();
    }

    // ---------------------------
    // Sidebar Functions
    // ---------------------------
    function toggleSidebar() {
        elements.sidebar.classList.toggle('collapsed');
        elements.mainContent.classList.toggle('expanded');
        setTimeout(resizeVideo, 0);
    }

    // ---------------------------
    // Keyboard Shortcut Functions
    // ---------------------------
    document.addEventListener('keydown', (event) => {
        // Don't handle shortcuts if we're in an input field or modal
        if (event.target.tagName === 'INPUT' || isModalOpen()) {
            return;
        }

        if (event.key === 'Escape') {
            if (elements.tagManagerModal.style.display === 'block') {
                closeTagManager();
            }
            if (elements.helpModal.style.display === 'block') {
                elements.helpModal.style.display = 'none';
            }
        } else if (event.key === ' ' || event.key === 'Spacebar') {
            event.preventDefault(); // Prevent page scrolling
            if (elements.videoPlayer.src) {
                if (elements.videoPlayer.paused) {
                    elements.videoPlayer.play();
                } else {
                    elements.videoPlayer.pause();
                }
            }
        } else if (isTagManagerOpen || isSettingsModalOpen) return;

        const key = event.key.toLowerCase();
        const shortcuts = settings.shortcuts;

        if (key === shortcuts.openTagManager.toLowerCase()) {
            event.preventDefault();
            openTagManager();
        } else if (key === shortcuts.addFrame.toLowerCase()) {
            event.preventDefault();
            addFrame();
            animateAddFrameButton();
        } else if (event.key === shortcuts.prevFrame) {
            //console.log(`Key pressed: ${key}`);

            navigateIndicators(-1);
        } else if (event.key === shortcuts.nextFrame) {
            //console.log(`Key pressed: ${key}`);

            navigateIndicators(1);
        } else if (isNumberKey(key)) {
            const tagIndex = parseInt(key) - 1;
            if (tagIndex < tags.length) {
                toggleTagForCurrentFrame(tags[tagIndex]);
                updateTagOverlay();
                updateFrameInfo();
            }
        }
    });

    function isNumberKey(key) {
        return /^[1-9]$/.test(key);
    }

    function navigateIndicators(direction) {
        if (!elements.videoPlayer.src || elements.videoPlayer.readyState === 0) {
            console.log("Video not loaded yet.");
            return;
        }

        if (selectedFrames.length === 0) {
            const step = direction * 2;
            elements.videoPlayer.currentTime = clampTime(elements.videoPlayer.currentTime + step);
            updateAllAfterTimeChange();
            return;
        }

        const currentTime = elements.videoPlayer.currentTime;
        let nearestFrameIndex = -1;
        let nearestFrameDistance = Infinity;

        selectedFrames.forEach((frameTime, index) => {
            const distance = frameTime - currentTime;
            if (direction === -1 && distance < 0 && Math.abs(distance) < nearestFrameDistance) {
                nearestFrameIndex = index;
                nearestFrameDistance = Math.abs(distance);
            } else if (direction === 1 && distance > 0 && distance < nearestFrameDistance) {
                nearestFrameIndex = index;
                nearestFrameDistance = distance;
            }
        });

        if (nearestFrameIndex === -1) {
            nearestFrameIndex = direction === -1 ? selectedFrames.length - 1 : 0;
        }

        if (nearestFrameIndex !== -1) {
            elements.videoPlayer.currentTime = selectedFrames[nearestFrameIndex];
            currentIndicatorIndex = nearestFrameIndex;
            updateAllAfterTimeChange();
        }
    }

    function clampTime(time) {
        return Math.max(0, Math.min(elements.videoPlayer.duration, time));
    }

    function updateAllAfterTimeChange() {
        updateFrameInfo();
        updateTagOverlay();
        updateActiveIndicator();
        updateScrubberPosition();
    }

    // ---------------------------
    // UI Animations
    // ---------------------------
    function animateAddFrameButton() {
        elements.addFrameButton.classList.add('button-pulse');
        setTimeout(() => {
            elements.addFrameButton.classList.remove('button-pulse');
        }, 300);
    }

    function animateLoadingMessage(message, element) {
        let dots = 0;
        const maxDots = 3;
        const interval = setInterval(() => {
            dots = (dots + 1) % (maxDots + 1);
            element.textContent = `${message}${'.'.repeat(dots)}`;
        }, 500);
        return interval;
    }

    // ---------------------------
    // Modal Management Functions
    // ---------------------------
    function handleWindowClick(event) {
        if (event.target === elements.tagManagerModal) {
            closeTagManager();
        }
        if (event.target === elements.helpModal) {
            elements.helpModal.style.display = 'none';
        }
    }

    function handleGlobalKeyDown(event) {
        // Don't handle shortcuts if we're in an input field or modal
        if (event.target.tagName === 'INPUT' || isModalOpen()) {
            return;
        }

        if (event.key === 'Escape') {
            if (elements.tagManagerModal.style.display === 'block') {
                closeTagManager();
            }
            if (elements.helpModal.style.display === 'block') {
                elements.helpModal.style.display = 'none';
            }
        } else if (event.key === ' ' || event.key === 'Spacebar') {
            event.preventDefault(); // Prevent page scrolling
            if (elements.videoPlayer.src) {
                if (elements.videoPlayer.paused) {
                    elements.videoPlayer.play();
                } else {
                    elements.videoPlayer.pause();
                }
            }
        }
    }

    function closeSettingsModal() {
        elements.settingsModal.style.display = 'none';
        isSettingsModalOpen = false;
    }

    // ---------------------------
    // Shortcut Handling Functions
    // ---------------------------
    function handleShortcutInput(event) {
        event.preventDefault();
        const key = event.key;
        let shortcut = '';

        if (event.ctrlKey) shortcut += 'Ctrl+';
        if (event.altKey) shortcut += 'Alt+';
        if (event.shiftKey) shortcut += 'Shift+';

        if (key.length === 1 && key.match(/[a-z]/i)) {
            shortcut += key.toUpperCase();
        } else {
            shortcut += key;
        }

        event.target.value = shortcut;

        const shortcutName = event.target.dataset.shortcut;
        settings.shortcuts[shortcutName] = shortcut;

        saveSettings();
        updateSettingsUI();
        updateShortcutDisplay();
    }

    function isShortcutInput(element) {
        return element.classList.contains('shortcut-input');
    }

    function updateShortcutDisplay() {
        const shortcutElements = document.querySelectorAll('.shortcut-key');
        shortcutElements.forEach(element => {
            const shortcutName = element.dataset.shortcut;
            element.textContent = settings.shortcuts[shortcutName];
        });

        elements.addFrameButton.textContent = `Add/Remove Frame (${settings.shortcuts.addFrame})`;
    }

    // ---------------------------
    // Settings Management Functions
    // ---------------------------
    function handleSettingsInput(event) {
        const input = event.target;
        if (input.id === 'imageQuality') {
            validateImageQuality();
        } else if (input.id in settings.export) {
            settings.export[input.id] = input.value;
        } else if (input.id.endsWith('Shortcut')) {
            const shortcutName = input.id.replace('Shortcut', '');
            settings.shortcuts[shortcutName] = input.value;
        } else if (input.id === 'showShortcutOverlay') {
            settings.display.showShortcutOverlay = input.checked;
            updateShortcutOverlayVisibility();
        }
        saveSettings();
        updateFrameInfo();
        updateSettingsUI();
    }

    function validateImageQuality() {
        const imageQualityInput = document.getElementById('imageQuality');
        let value = parseInt(imageQualityInput.value, 10);
        if (isNaN(value) || value < 1) {
            value = 1;
        } else if (value > 100) {
            value = 100;
        }
        imageQualityInput.value = value;
        settings.export.imageQuality = value;
        saveSettings();
    }

    function updateSettingsUI() {
        document.getElementById('addFrameShortcut').value = settings.shortcuts.addFrame;
        document.getElementById('prevFrameShortcut').value = settings.shortcuts.prevFrame;
        document.getElementById('nextFrameShortcut').value = settings.shortcuts.nextFrame;
        document.getElementById('openTagManagerShortcut').value = settings.shortcuts.openTagManager;
        document.getElementById('imageFormat').value = settings.export.imageFormat;
        document.getElementById('imageQuality').value = settings.export.imageQuality;
        document.getElementById('zipFileName').value = settings.export.zipFileName;
        document.getElementById('imageFilePrefix').value = settings.export.imageFilePrefix;
        document.getElementById('showShortcutOverlay').checked = settings.display.showShortcutOverlay;

        updateShortcutDisplay();
        updateQualityInputVisibility();
        updateShortcutOverlayVisibility();
    }

    function updateQualityInputVisibility() {
        const imageQualityInput = document.getElementById('imageQuality');
        const imageQualityLabel = imageQualityInput.previousElementSibling;
        const isVisible = settings.export.imageFormat !== 'png';
        imageQualityInput.style.display = isVisible ? 'block' : 'none';
        imageQualityLabel.style.display = isVisible ? 'block' : 'none';
    }

    function updateShortcutOverlayVisibility() {
        elements.shortcutOverlay.style.display = settings.display.showShortcutOverlay ? 'block' : 'none';
    }

    // ---------------------------
    // Settings Persistence Functions
    // ---------------------------
    function loadSettings() {
        const savedSettings = localStorage.getItem('videoFramesSettings');
        if (savedSettings) {
            const parsedSettings = JSON.parse(savedSettings);
            settings = {
                ...settings,
                ...parsedSettings,
                display: {
                    ...settings.display,
                    ...parsedSettings.display
                }
            };
        }
        initializeShortcutOverlay();
    }

    function saveSettings() {
        localStorage.setItem('videoFramesSettings', JSON.stringify(settings));
    }

    function initializeShortcutOverlay() {
        updateShortcutOverlayVisibility();
        updateShortcutDisplay();
    }

    // ---------------------------
    // Load Session Functions
    // ---------------------------
    async function handleLoadSession(event) {
        const file = event.target.files[0];
        if (file) {
            showLoadingIndicator('Loading session...');
            try {
                const zip = await JSZip.loadAsync(file);
                const sessionFile = findSessionFile(zip);
                if (!sessionFile) {
                    throw new Error('Invalid session file. ZIP must contain a session.json file.');
                }

                const sessionData = await sessionFile.async('string').then(JSON.parse);
                await loadSessionData(zip, sessionData);

                displayOutput(`Session "${sessionData.zipFileName}.zip" loaded successfully.`);
                stopUploadButtonAnimation();
            } catch (error) {
                console.error('Error loading session:', error);
                displayError(`Error loading session: ${error.message}`);
            } finally {
                hideLoadingIndicator();
            }
        }
    }

    function findSessionFile(zip) {
        for (const filename in zip.files) {
            if (filename.endsWith('session.json')) {
                return zip.files[filename];
            }
        }
        return null;
    }

    async function loadSessionData(zip, sessionData) {
        originalVideoName = sessionData.videoName;
        settings = sessionData.settings || settings;
        tags = sessionData.tags || [];
        selectedFrames = sessionData.selectedFrames || [];
        frameTags = sessionData.frameTags || {};

        loadSettings();
        renderTags();
        updateScreenshotIndicators();
        updateTagOverlay();
        updateFrameCounter();
        updateFrameInfo();
        updateExtractButtonState();

        const videoFile = await findVideoFile(zip, sessionData);
        if (!videoFile) {
            throw new Error('Invalid session file. ZIP must contain a video file.');
        }

        const videoBlob = await videoFile.async('blob');
        const videoExtension = getVideoExtension(videoBlob, videoFile.name);
        videoSrc = URL.createObjectURL(new Blob([videoBlob], { type: `video/${videoExtension}` }));
        elements.videoPlayer.src = videoSrc;

        await new Promise(resolve => {
            elements.videoPlayer.onloadedmetadata = resolve;
        });

        if (elements.videoPlayer.videoWidth === 0 || elements.videoPlayer.videoHeight === 0) {
            throw new Error('Unsupported video format in session.');
        }

        showUIElements(true);
        resizeVideo();
        resetScrubberAndProgress();
        hideVideoPlaceholder();

        updateScreenshotIndicators();
        updateTagOverlay();
        updateFrameCounter();
        updateFrameInfo();
    }
    async function findVideoFile(zip, sessionData) {
        console.log('Finding video file in zip...');
        const sessionFolder = getSessionFolder(zip, 'session.json');
        console.log(`Session folder: ${sessionFolder}`);

        // Look for any video file in the session folder
        for (const filename in zip.files) {
            if (filename.startsWith(sessionFolder) && isVideoFile(filename)) {
                console.log(`Video file found: ${filename}`);
                return zip.files[filename];
            }
        }

        console.log('Video file not found');
        return null;
    }

    function isVideoFile(filename) {
    const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.wmv', '.flv', '.mkv'];
    return videoExtensions.some(ext => filename.toLowerCase().endsWith(ext));
}

    function getSessionFolder(zip, sessionFilename) {
        console.log(`Searching for session folder containing ${sessionFilename}...`);
        for (const filename in zip.files) {
            console.log(`Checking file: ${filename}`);
            if (filename.endsWith(sessionFilename)) {
                const folder = filename.substring(0, filename.lastIndexOf('/') + 1);
                console.log(`Session folder found: ${folder}`);
                return folder;
            }
        }
        console.log('Session folder not found');
        return '';
    }

    // ---------------------------
    // Helper Functions
    // ---------------------------
    function preventDefaultDrag(e) {
        e.preventDefault();
    }

    function isModalOpen() {
        return elements.tagManagerModal.style.display === 'block' || elements.helpModal.style.display === 'block' || elements.settingsModal.style.display === 'block';
    }

    function showLoadingIndicator(message) {
        const loadingMessage = createLoadingMessage(message);
        elements.loadingIndicator.appendChild(loadingMessage);
        elements.loadingIndicator.style.display = 'flex';
    }

    function hideLoadingIndicator() {
        elements.loadingIndicator.style.display = 'none';
        elements.loadingIndicator.innerHTML = '';
    }

})();

</script>
</body>
</html>

